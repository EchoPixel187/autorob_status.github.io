<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Admin Panel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg-main: #111111;
  --bg-content: #181818;
  --bg-table: #1f1f1f;
  --bg-hover: #262626;
  --accent: #00bfff;
  --text-main: #ffffff;
  --text-muted: #aaaaaa;
}

* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

body {
  margin: 0;
  background: var(--bg-main);
  color: var(--text-main);
}

.container {
  max-width: 1100px;
  margin: 50px auto;
  background: var(--bg-content);
  padding: 30px;
  border-radius: 12px;
}

h2 {
  margin-top: 0;
  color: var(--accent);
}

button {
  background: var(--accent);
  border: none;
  padding: 10px 18px;
  color: black;
  font-weight: bold;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  opacity: 0.85;
}

input {
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #222;
  color: white;
  width: 100%;
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: var(--bg-table);
}

th, td {
  padding: 12px;
  text-align: left;
}

th {
  background: #222;
  color: var(--accent);
}

tr {
  border-bottom: 1px solid #333;
}

tr:hover {
  background: var(--bg-hover);
}

.badge {
  background: var(--accent);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  color: black;
}

#status {
  margin-top: 15px;
  color: var(--text-muted);
}

.hidden {
  display: none;
}
</style>
</head>
<body>

<div class="container">

  <!-- LOGIN -->
  <div id="loginView">
    <h2>Admin Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Passwort">
    <button onclick="login()">Anmelden</button>
    <p id="loginStatus"></p>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminView" class="hidden">
    <h2>Admin Status Panel</h2>
    <button onclick="logout()">Logout</button>

    <table id="table">
      <tr>
        <th>User ID</th>
        <th>Username</th>
        <th>Time</th>
        <th>IP-Adresse</th>
        <th>Server ID</th>
      </tr>
    </table>

    <p id="status"></p>
  </div>

</div>

<script>
const supabaseClient = supabase.createClient(
  "https://mpalntykgnflxqbswykw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wYWxudHlrZ25mbHhxYnN3eWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0Mzk4OTcsImV4cCI6MjA4NzAxNTg5N30.qw5jyCIdKB9q9Tjp12Oxhwo1DBX_NCISugf_ahB-9lw"
)

supabaseClient.auth.getSession().then(({ data }) => {
  if (data.session) showAdmin()
})

supabaseClient.auth.onAuthStateChange((event, session) => {
  if (session) showAdmin()
  else showLogin()
})

function showAdmin() {
  document.getElementById("loginView").classList.add("hidden")
  document.getElementById("adminView").classList.remove("hidden")
  loadLogs()
}

function showLogin() {
  document.getElementById("adminView").classList.add("hidden")
  document.getElementById("loginView").classList.remove("hidden")
}

async function login() {
  const username = document.getElementById("username").value
  const password = document.getElementById("password").value

  // Fake Email erzeugen
  const email = username + "@admin.local"

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  })

  if (error) {
    document.getElementById("loginStatus").innerText = error.message
  }
}

async function logout() {
  await supabaseClient.auth.signOut()
}

function resetTable() {
  const table = document.getElementById("table")
  table.innerHTML = `
    <tr>
      <th>User ID</th>
      <th>Username</th>
      <th>Time</th>
      <th>IP-Adresse</th>
      <th>Server ID</th>
    </tr>
  `
  return table
}

function getValue(row, keys) {
  for (const key of keys) {
    if (row[key]) return row[key]
  }
  return ""
}

async function loadLogs() {
  const table = resetTable()
  document.getElementById("status").innerText = "Lade Logs..."

  const { data, error } = await supabaseClient
    .from("EH_Admin_Stats")
    .select("*")
    .limit(500)

  if (error) {
    document.getElementById("status").innerText = error.message
    return
  }

  if (!data || data.length === 0) {
    document.getElementById("status").innerText = "Keine Logs gefunden"
    return
  }

  data.sort((a,b) => new Date(b.created_at) - new Date(a.created_at))

  data.forEach(row => {
    const tr = document.createElement("tr")
    tr.innerHTML = `
      <td>${getValue(row, ["user_id","id"])}</td>
      <td>${getValue(row, ["username","name"])}</td>
      <td>${getValue(row, ["created_at","time"])}</td>
      <td>${getValue(row, ["ip_address","ip"])}</td>
      <td><span class="badge">${getValue(row, ["server_id","serverId"])}</span></td>
    `
    table.appendChild(tr)
  })

  document.getElementById("status").innerText = data.length + " Logs geladen"
}

setInterval(() => {
  if (!document.getElementById("adminView").classList.contains("hidden")) {
    loadLogs()
  }
}, 10000)
</script>

</body>
</html>
