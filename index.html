<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Script Logs</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h2>Logs</h2>
<table border="1" id="table">
  <tr>
    <th>User ID</th>
    <th>Username</th>
    <th>Time</th>
    <th>IP-Adresse</th>
  </tr>
</table>
<p id="status"></p>

<script>
const supabaseClient = supabase.createClient(
  "https://mpalntykgnflxqbswykw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wYWxudHlrZ25mbHhxYnN3eWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0Mzk4OTcsImV4cCI6MjA4NzAxNTg5N30.qw5jyCIdKB9q9Tjp12Oxhwo1DBX_NCISugf_ahB-9lw"
)

const tableCandidates = ["EH_Admin_Stats", "eh_admin_stats"]

function setStatus(message, isError = false) {
  const status = document.getElementById("status")
  status.textContent = message
  status.style.color = isError ? "crimson" : "black"
}

function resetTable() {
  const table = document.getElementById("table")
  table.innerHTML = ""

  const headerRow = document.createElement("tr")
  ;["User ID", "Username", "Time", "IP-Adresse"].forEach(label => {
    const th = document.createElement("th")
    th.textContent = label
    headerRow.appendChild(th)
  })
  table.appendChild(headerRow)

  return table
}

function addInfoRow(table, text, isError = false) {
  const row = document.createElement("tr")
  const cell = document.createElement("td")
  cell.colSpan = 4
  cell.textContent = text
  if (isError) {
    cell.style.color = "crimson"
  }
  row.appendChild(cell)
  table.appendChild(row)
}

function getValue(row, keys) {
  for (const key of keys) {
    if (row[key] !== undefined && row[key] !== null && row[key] !== "") {
      return row[key]
    }
  }
  return ""
}

async function loadLogs() {
  const table = resetTable()
  setStatus("Lade Logs...")

  let lastError = null
  let data = null
  let usedTable = null

  for (const tableName of tableCandidates) {
    const result = await supabaseClient
      .from(tableName)
      .select("*")
      .limit(500)

    if (!result.error) {
      data = result.data || []
      usedTable = tableName
      break
    }

    lastError = { tableName, error: result.error }
  }

  if (!usedTable) {
    console.error("Supabase Error:", lastError)
    addInfoRow(table, "Fehler beim Laden der Logs. Details in der Browser-Konsole.", true)
    setStatus("Supabase-Fehler: " + (lastError?.error?.message || "Unbekannt"), true)
    return
  }

  if (!data || data.length === 0) {
    addInfoRow(
      table,
      "Keine Logs gefunden. Falls Daten in Supabase vorhanden sind, pruefe RLS-SELECT-Policy und Schema/Tabellennamen."
    )
    setStatus("0 Logs geladen aus Tabelle: " + usedTable)
    return
  }

  data.sort((a, b) => {
    const aTime = Date.parse(String(getValue(a, ["created_at", "time", "logged_at", "inserted_at"])))
    const bTime = Date.parse(String(getValue(b, ["created_at", "time", "logged_at", "inserted_at"])))
    const aValid = Number.isFinite(aTime)
    const bValid = Number.isFinite(bTime)
    if (aValid && bValid) return bTime - aTime
    if (aValid) return -1
    if (bValid) return 1
    return 0
  })

  data.forEach(row => {
    const tr = document.createElement("tr")

    const userId = document.createElement("td")
    userId.textContent = String(getValue(row, ["user_id", "userid", "id"]))
    tr.appendChild(userId)

    const username = document.createElement("td")
    username.textContent = String(getValue(row, ["username", "player_name", "name"]))
    tr.appendChild(username)

    const createdAt = document.createElement("td")
    createdAt.textContent = String(getValue(row, ["created_at", "time", "logged_at", "inserted_at"]))
    tr.appendChild(createdAt)

    const ipAddress = document.createElement("td")
    ipAddress.textContent = String(getValue(row, ["ip-adress", "ip_address", "ip"]))
    tr.appendChild(ipAddress)

    table.appendChild(tr)
  })

  setStatus(data.length + " Logs geladen aus Tabelle: " + usedTable)
}

loadLogs()
setInterval(loadLogs, 10000)
</script>

</body>
</html>
