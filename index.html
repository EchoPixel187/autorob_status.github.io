<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Admin Panel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg-main: #111111;
  --bg-content: #181818;
  --bg-table: #1f1f1f;
  --bg-hover: #262626;
  --accent: #00bfff;
  --text-main: #ffffff;
  --text-muted: #aaaaaa;
}

* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

body {
  margin: 0;
  background: var(--bg-main);
  color: var(--text-main);
}

.container {
  max-width: 1100px;
  margin: 50px auto;
  background: var(--bg-content);
  padding: 30px;
  border-radius: 12px;
}

h2 {
  margin-top: 0;
  color: var(--accent);
}

button {
  background: var(--accent);
  border: none;
  padding: 10px 18px;
  color: black;
  font-weight: bold;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  opacity: 0.85;
}

input {
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #222;
  color: white;
  width: 100%;
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: var(--bg-table);
}

th, td {
  padding: 12px;
  text-align: left;
}

th {
  background: #222;
  color: var(--accent);
}

tr {
  border-bottom: 1px solid #333;
}

tr:hover {
  background: var(--bg-hover);
}

.badge {
  background: var(--accent);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  color: black;
}

.number-cell {
  white-space: nowrap;
}

.toggle-row-btn {
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  color: var(--accent);
  padding: 0;
  width: 20px;
  height: 20px;
  line-height: 18px;
  text-align: center;
  font-size: 14px;
  font-weight: bold;
  border-radius: 4px;
  margin-right: 8px;
}

.toggle-row-btn:hover {
  opacity: 1;
  background: #333333;
}

.toggle-placeholder {
  display: inline-block;
  width: 20px;
  margin-right: 8px;
}

.group-meta {
  margin-left: 8px;
  color: var(--text-muted);
  font-size: 12px;
}

.child-row {
  display: none;
}

.child-row.expanded {
  display: table-row;
}

#status {
  margin-top: 15px;
  color: var(--text-muted);
}

.hidden {
  display: none;
}
</style>
</head>
<body>

<div class="container">

  <!-- LOGIN -->
  <div id="loginView">
    <h2>Admin Login</h2>
    <input type="email" id="email" placeholder="E-Mail">
    <input type="password" id="password" placeholder="Passwort">
    <button onclick="login()">Anmelden</button>
    <p id="loginStatus"></p>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminView" class="hidden">
    <h2>Admin Status Panel</h2>
    <button onclick="logout()">Logout</button>

    <table id="table">
      <tr>
        <th>Nr.</th>
        <th>User ID</th>
        <th>Username</th>
        <th>Time</th>
        <th>IP-Adresse</th>
        <th>Server ID</th>
      </tr>
    </table>

    <p id="status"></p>
  </div>

</div>

<script>
const supabaseClient = supabase.createClient(
  "https://mpalntykgnflxqbswykw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wYWxudHlrZ25mbHhxYnN3eWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0Mzk4OTcsImV4cCI6MjA4NzAxNTg5N30.qw5jyCIdKB9q9Tjp12Oxhwo1DBX_NCISugf_ahB-9lw"
)

supabaseClient.auth.getSession().then(({ data }) => {
  if (data.session) showAdmin()
})

supabaseClient.auth.onAuthStateChange((event, session) => {
  if (session) showAdmin()
  else showLogin()
})

let activeLoadRequest = 0

function showAdmin() {
  const adminView = document.getElementById("adminView")
  const loginView = document.getElementById("loginView")
  const wasHidden = adminView.classList.contains("hidden")

  loginView.classList.add("hidden")
  adminView.classList.remove("hidden")

  // Verhindert doppeltes Initial-Laden, wenn Session-Events mehrfach feuern.
  if (wasHidden) loadLogs()
}

function showLogin() {
  activeLoadRequest++
  document.getElementById("adminView").classList.add("hidden")
  document.getElementById("loginView").classList.remove("hidden")
}

async function login() {
  const email = document.getElementById("email").value.trim()
  const password = document.getElementById("password").value

  if (!email) {
    document.getElementById("loginStatus").innerText = "Bitte E-Mail eingeben."
    return
  }

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  })

  if (error) {
    document.getElementById("loginStatus").innerText = error.message
  }
}

async function logout() {
  await supabaseClient.auth.signOut()
}

function resetTable() {
  const table = document.getElementById("table")
  table.innerHTML = `
    <tr>
      <th>Nr.</th>
      <th>User ID</th>
      <th>Username</th>
      <th>Time</th>
      <th>IP-Adresse</th>
      <th>Server ID</th>
    </tr>
  `
  return table
}

function getValue(row, keys) {
  for (const key of keys) {
    if (Object.prototype.hasOwnProperty.call(row, key) && row[key] !== null && row[key] !== undefined) {
      return row[key]
    }
  }
  return ""
}

function toggleUserRows(groupId, button) {
  const isExpanded = button.getAttribute("aria-expanded") === "true"
  const shouldExpand = !isExpanded
  const rows = document.querySelectorAll(`tr[data-group-child="${groupId}"]`)

  rows.forEach((row) => {
    row.classList.toggle("expanded", shouldExpand)
  })

  button.setAttribute("aria-expanded", shouldExpand ? "true" : "false")
  button.innerText = shouldExpand ? "-" : "+"
}

function createLogRow(row, rowNumber, options = {}) {
  const serverId = getValue(row, ["server-id","server_id","serverId"])
  const userId = getValue(row, ["user_id","id"])
  const username = getValue(row, ["username","name"])
  const time = getValue(row, ["created_at","time"])
  const ipAddress = getValue(row, ["ip-adress","ip_address","ip"])
  const showToggle = options.showToggle === true
  const isChild = options.isChild === true
  const groupId = options.groupId || ""
  const hiddenCount = options.hiddenCount || 0

  const toggleControl = showToggle
    ? `<button type="button" class="toggle-row-btn" aria-expanded="false">+</button>`
    : `<span class="toggle-placeholder"></span>`

  const meta = !isChild && hiddenCount > 0
    ? `<span class="group-meta">+${hiddenCount} weitere</span>`
    : ""

  const tr = document.createElement("tr")
  if (isChild) {
    tr.classList.add("child-row")
    tr.dataset.groupChild = groupId
  }

  tr.innerHTML = `
    <td class="number-cell">${toggleControl}${rowNumber}</td>
    <td>${userId}</td>
    <td>${username}${meta}</td>
    <td>${time}</td>
    <td>${ipAddress}</td>
    <td><span class="badge">${serverId || "-"}</span></td>
  `

  if (showToggle && groupId) {
    const button = tr.querySelector(".toggle-row-btn")
    button.addEventListener("click", () => toggleUserRows(groupId, button))
  }

  return tr
}

async function loadLogs() {
  const requestId = ++activeLoadRequest
  const table = resetTable()
  document.getElementById("status").innerText = "Lade Logs..."

  const { data, error } = await supabaseClient
    .from("EH_Admin_Stats")
    .select("*")
    .limit(500)

  if (error) {
    if (requestId !== activeLoadRequest) return
    document.getElementById("status").innerText = error.message
    return
  }

  if (!data || data.length === 0) {
    if (requestId !== activeLoadRequest) return
    document.getElementById("status").innerText = "Keine Logs gefunden"
    return
  }

  data.sort((a,b) => new Date(b.created_at) - new Date(a.created_at))

  if (requestId !== activeLoadRequest) return

  const groupedLogs = new Map()
  for (let i = 0; i < data.length; i++) {
    if (requestId !== activeLoadRequest) return
    const row = data[i]
    const userId = String(getValue(row, ["user_id","id"]) || "unknown")
    if (!groupedLogs.has(userId)) groupedLogs.set(userId, [])
    groupedLogs.get(userId).push(row)
  }

  let rowNumber = 1
  let groupCounter = 0

  for (const rows of groupedLogs.values()) {
    if (requestId !== activeLoadRequest) return

    const groupId = "group-" + requestId + "-" + groupCounter
    groupCounter++

    const mainRow = createLogRow(rows[0], rowNumber, {
      showToggle: rows.length > 1,
      groupId,
      hiddenCount: rows.length - 1
    })
    table.appendChild(mainRow)
    rowNumber++

    for (let i = 1; i < rows.length; i++) {
      if (requestId !== activeLoadRequest) return
      const childRow = createLogRow(rows[i], rowNumber, {
        isChild: true,
        groupId
      })
      table.appendChild(childRow)
      rowNumber++
    }
  }

  if (requestId !== activeLoadRequest) return
  document.getElementById("status").innerText = data.length + " Logs geladen (" + groupedLogs.size + " User)"
}

setInterval(() => {
  if (!document.getElementById("adminView").classList.contains("hidden")) {
    loadLogs()
  }
}, 10000)
</script>

</body>
</html>
